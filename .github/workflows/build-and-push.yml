name: Build, Scan and Push Microservices

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  build_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ---- SonarCloud Scan ----
    - name: SonarCloud Scan
      uses: sonarsource/sonarqube-scan-action@v5.0.0
      with:
        projectBaseDir: .
        args: >
          -Dsonar.projectKey=cloning-ecommerce
          -Dsonar.organization=pammietl4
          -Dsonar.branch.name=master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    # - name: SonarQube Self-Hosted Scan (commented for cloud only)
    #   uses: sonarsource/sonarqube-scan-action@v5.0.0
    #   with:
    #     host: ${{ secrets.SONARQUBE_HOST }}
    #     login: ${{ secrets.SONARQUBE_TOKEN }}
    #     projectBaseDir: .
    #     args: >
    #       -Dsonar.projectKey=cloning-ecommerce
    #       -Dsonar.organization=pammietl4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build, Scan, and Push Changed Images
      run: |
        services=("user-service" "product-service" "cart-service" "order-service" "payment-service")
        built=()
        scanned=()
        pushed=()
        skipped=()
        failed=()
        if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }})
        else
          git fetch --prune --unshallow || true
          CHANGED=$(git diff --name-only ${{ github.sha }}^ ${{ github.sha }})
        fi
        VERSION="v1.${{ github.run_number }}"
        echo "üîÑ Starting build process... Version: $VERSION"
        for service in "${services[@]}"; do
          if echo "$CHANGED" | grep "^$service/" > /dev/null; then
            if [ -d "$service" ]; then
              echo "üöÄ Building Docker image for $service ..."
              if docker build -t ${{ secrets.DOCKER_USERNAME }}/$service:latest -t ${{ secrets.DOCKER_USERNAME }}/$service:$VERSION ./$service; then
                built+=("$service")
                echo "‚úÖ Build successful for $service"
              else
                failed+=("$service")
                echo "‚ùå Build FAILED for $service"
                continue
              fi
              echo "üîç Scanning Docker image with Trivy for vulnerabilities ..."
              if docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                aquasec/trivy:latest image --exit-code 1 --severity HIGH,CRITICAL \
                ${{ secrets.DOCKER_USERNAME }}/$service:latest; then
                echo "üü¢ Trivy scan PASSED: $service image has NO high/critical vulnerabilities"
                scanned+=("$service")
              else
                failed+=("$service")
                echo "‚ùå Trivy scan FAILED for $service - vulnerabilities found, NOT pushing"
                continue
              fi
              echo "üì§ Pushing Docker images to Docker Hub ..."
              if docker push ${{ secrets.DOCKER_USERNAME }}/$service:latest \
                && docker push ${{ secrets.DOCKER_USERNAME }}/$service:$VERSION; then
                pushed+=("$service")
                echo "‚úÖ Push successful for $service"
              else
                failed+=("$service")
                echo "‚ùå Push FAILED for $service"
              fi
              echo "‚úÖ $service build, scan & push completed successfully"
            else
              skipped+=("$service")
              echo "‚ö†Ô∏è Skipping $service ‚Äî folder not found"
            fi
          else
            skipped+=("$service")
            echo "‚è≠Ô∏è Skipping $service ‚Äî no changes detected"
          fi
        done
        echo ""
        echo "================ PIPELINE SUMMARY ================"
        echo "Version: $VERSION"
        echo "Trigger: $GITHUB_EVENT_NAME"
        [ ${#built[@]} -gt 0 ] && echo "‚úÖ Built:    ${built[*]}"
        [ ${#scanned[@]} -gt 0 ] && echo "üîç Scanned:  ${scanned[*]}"
        [ ${#pushed[@]} -gt 0 ] && echo "üì§ Pushed:   ${pushed[*]}"
        [ ${#skipped[@]} -gt 0 ] && echo "‚è≠Ô∏è Skipped:  ${skipped[*]}"
        [ ${#failed[@]} -gt 0 ] && echo "‚ùå Failed:   ${failed[*]}"
        echo "================================================="
        if [ ${#failed[@]} -gt 0 ]; then
          echo "‚ùå Pipeline completed with failures"
          exit 1
        else
          echo "üéâ Pipeline completed successfully"
        fi