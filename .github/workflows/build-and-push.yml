name: Build and Push Microservices

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Services
      run: |
        # Declare list of microservices
        services=("user-service" "product-service" "cart-service" "order-service" "payment-service")

        # Auto version tag using GitHub run number
        VERSION="v1.${{ github.run_number }}"

        echo "üîÑ Starting build process... Version: $VERSION"

        for service in "${services[@]}"; do
          if [ -d "$service" ]; then
            echo "üöÄ Building $service ..."
            
            docker build -t ${{ secrets.DOCKER_USERNAME }}/$service:latest -t ${{ secrets.DOCKER_USERNAME }}/$service:$VERSION ./$service

            echo "üì§ Pushing $service ..."
            docker push ${{ secrets.DOCKER_USERNAME }}/$service:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/$service:$VERSION

            echo "‚úÖ $service build & push completed successfully"
          else
            echo "‚ö†Ô∏è Skipping $service ‚Äî folder not found"
          fi
        done

        echo "üéâ All available services have been processed."