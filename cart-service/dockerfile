# -------- Stage 1: Build/Install dependencies --------
FROM node:20-slim AS builder

WORKDIR /cart-service

COPY package.json .
RUN npm install --production

# -------- Stage 2: Minimal runtime --------
FROM node:20-slim

WORKDIR /cart-service

# Patch CRITICAL zlib vulnerability (until base image updates)
RUN apt-get update && apt-get install -y --only-upgrade zlib1g

COPY --from=builder /cart-service/node_modules ./node_modules
COPY server.js .

USER node

EXPOSE 8001

CMD ["node", "server.js"]